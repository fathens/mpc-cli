pub mod ecdsa;

use crate::CryptoError;
use crate::Result;
use common::prime::miller_rabin::is_prime;
use common::random::get_random_generator_of_the_quadratic_residue;
use num_bigint::BigUint;

#[derive(Debug, Clone, Hash, PartialEq, Eq)]
pub struct NTildei {
    pub n: BigUint,
    pub v1: BigUint,
    pub v2: BigUint,
}

impl NTildei {
    pub fn generate(prime1: BigUint, prime2: BigUint) -> Result<Self> {
        if !is_prime(&prime1, Some(30)) || !is_prime(&prime2, Some(30)) {
            return Err(CryptoError::need_primes());
        }
        let n = prime1 * prime2;
        let v1 = get_random_generator_of_the_quadratic_residue(&n).map_err(CryptoError::from)?;
        let v2 = get_random_generator_of_the_quadratic_residue(&n).map_err(CryptoError::from)?;
        Ok(NTildei { n, v1, v2 })
    }

    #[cfg(test)]
    pub fn generate_for_test() -> &'static [NTildei; 5] {
        &test::NTILDEI_SAMPLES
    }
}

#[cfg(test)]
mod test {
    use super::*;
    use once_cell::sync::Lazy;
    use std::str::FromStr;

    pub static NTILDEI_SAMPLES: Lazy<[NTildei; 5]> = Lazy::new(|| {
        [
            NTildei {
                n: BigUint::from_str("25107490776052945575790163886980744121852075793230702092031092910315419013111724585107741342302647097816029689069156500419649067226989207335403141846585589456214707140363806918024254341805807847344462552372749802373561411623464018306841140152736878126807643286464707464144491205717529334857128642937311664356950670200785184493082292988908234459722618881044613550904554507333793627844968327344517418351075665978629614435510466378211576459017353838583039397930178040557511540818370302033808216608330168909665648805527673068950251148153088673193641290377199021831923470431364077200419352774733381328839199321622201645277").unwrap(),
                v1: BigUint::from_str("947268510305326446073634507724913447936734171636912400557401318775427643035322780043344044871778218536295489345747992085537349997385753459769909944243608187249295932620582767525243046024431872134558350124222211815956076009495579000118546531817489783543950708796804986346442485595844139040615169351977594594085460608932273701244091036215057114383266995365365226626217411088112095883376367775475107954293975266374705057036496941779873360807750450088301028537780564210964889218799820623451941121168857520561736570209171665676631521362739174866629364755585577716299287494251706261472512421959632149833106509542229972234").unwrap(),
                v2: BigUint::from_str("369382535766024782757053511943484023707590301248858510505619543451105355366349475321600848828578055383112252081262740450957242693258711711573898608872557215737850380375149487180022863563616178163440683814662347260503803753150609907077552201623376131096249150783552367189222999632342102603491398593162398739317344334427947844029843540621897547082716967267285286086227255034044222917612280937408214149645699005643727644027239999997789724357422423935120674874708262799420509411969660535187315093553065000790565517535769427338692918882249946664488170641583406635227373502217028982923125561321182147198392699754510926843").unwrap(),
            },
            NTildei {
                n: BigUint::from_str("25347321253130040165669198464747637594561084543160875890419030859255281770152898118930416834987900972848102624649324216864737441361174703716495863609322476087408028387965233238285802668149470294745292681572931725456001393301305606431470624857854001369500295623909754190673037775702216922020351830224578270444039819022050738946522292544390839130641700344286132805509002888252787493089063466842186838763536749516490621525613122365080892293964923531037888659136998882617232588657938236946761539565880695421135081565601958037809654399412376843665230604400657963765839300124472222517361299084266084873325229770349534163801").unwrap(),
                v1: BigUint::from_str("3880611998802971481733631912608098494196262778323132826239497201888814778206565779038508295122457059564658474446013387570155222804192995563846151508944721213706421845709980882611956739258515443677158361364276786837940404625680574358803765552923094221476122072037719326145018613827892918963555625064867923347247217043400958580189757825375746004023039968242295816205605839011845166061436412284630990719600784460170159747697580968014664501419463157750169639809058771175198577548493272625218114926414363501638734650889306046401503137104184980837461670247903219705017626260602184962369771097797399062562513353217770565531").unwrap(),
                v2: BigUint::from_str("15969079226966183502382475788401338523488393107499291032002044296474627394217596503568693748659928310923714663501210832583018731196547300812154979725769686288361401778491755680431944887852103221593745623856378860738388368922715577130878948380171217565406616753411777571011139446871620361320986832525400727639941640937364793530207582464684574638726091525574744197708378588020682070096454926012197394347212926657909811288708691651092564968341401161265195710381753419063864921935963903871011102644256286369641306466313805437318014970058871604639507243703932226939038829663830985880788590281053591951619664726739953671018").unwrap(),
            },
            NTildei {
                n: BigUint::from_str("21292308023632581181198289513256444712308177801737936647775817904740223548406904422170044682275257431431315028868812996459652895591102638516259762883465973519952131280804384814232387700680465986308431924126707276653911414520068641511680988816011871501850341616042836704357314055609697319128691732749390230733118584785117859207288385865822542643892497962395263780902218346962474333143560514409678469862250207440675303576178809488957082804485944446225032956319749038833642485681946267959990181650810435723731755627693490958402541015772649403218387116342415453965710612578891122860080475980560084488514089712934013739781").unwrap(),
                v1: BigUint::from_str("10831225843690707396172531846155417775408096606230693395561759792282094678514600816663347869748948927505461627250570771469119140533266318664691242702922064589002187370016461932692821183944924214028723777910582605988927471997349297521445102656640882914313554019001846714781268540993241638422699989309757114468372538565383360692272346876551928106077801669528247179220120217249637229522616724754257258083101113512544707361337883525289735840725085893321825199206160881032044949147621462286088226618153585859120352649591156109044603116965314576319186213041333237791389005373191075396808136402252420638572954706343475908070").unwrap(),
                v2: BigUint::from_str("4991965837400033768069871541004261063135140339060316531025599789490182217840042887067892359235887756385798984623237629620830856274859128458536333773291056510054624668039972342087961925191332459597054733496082441434562377800869508105363637144128472861641912914050632826421706717769073047295100882343425757237060029497292934794235607113222710491355298594636899811931946648047811854321545995037508110462735244536402582555614331492107887985617810756386029525697146027973237905139754077084275404126435090136074550061845235250362605148173730041087342012184590101575852114035899339078096801167678750962125251280492197772961").unwrap(),
            },
            NTildei {
                n: BigUint::from_str("30862742439593241585708940738147962226366718050501165321237842572436669411737554224118298772517486812375362296405238805912443683584456437953738131350045938787466841040220797401584428446174730486886913719857484102733725336155131475996004306581440515141136345274453183481082707684162136893963291137234740111704738897973555849945611157507740799100242851006495725457213328987753002399448999330977114104566617308036743409045315165685308303262653843118404666538923863063081603256452671995759383632696290823794779551389200638930288120410329395673124242908818519519330118489440718827371013019585524024323106350150372893461689").unwrap(),
                v1: BigUint::from_str("7379047495513012741768052948709028575585555485999633742902872635999567523931496397934138722681164927896829567152505037328183413349521525062101059035871423959216606865846805649228889409341121623645276995775466833580910793875325853108618331288089921648034916011339650914136927737993536151052450142994995957064434847339676185441357826456108823451579572271337009853306909251138234707237745952438799718674765118984490163866366131359672038740868456547662412411582409607895270049993194846640187000629665900662666631953358892682510778724505052220510687061629914270273761091793976303803161711621832014373503323366016634630406").unwrap(),
                v2: BigUint::from_str("23064781826724373162059309790268929175652024853806919970585039362565178134882146726172590403276064143405780341854075186376431326467367967581674319153076910116152907650926195389275015857432169732825486479963071595528043281158690951801576413614814760292960443710324174730418861380180819802157714395735784311928236401433597447641321165573011917942945482934111736905171027083754748263370419119297225245442731766002872688005764140266867116940180286239156118891196076208004108028110204585118322786319227036687507415330523815192275901354672284703528348057050369197376684323825935099945673108591425248965307506340817771591441").unwrap(),
            },
            NTildei {
                n: BigUint::from_str("22979378405138893589556133897521754683725883868866200124855036635451629318130978502381364148180090802113404290988890710862982965215323041776178270890557477521858892737028622171038670089616608354902721183960978083779850093600290031995183687729693685221986115197995396115379213021683786733329612441286209467155931087319154615773299643384467163395079212511182788668809520330816917834693871112365384301753056859879036141250397887546537837356226101620007886380291232478721279115321079877121757818532329118011682430897866452653899829996834157870634757693124417404439069108796004756126487268680259509658734527559041787231993").unwrap(),
                v1: BigUint::from_str("11181628178709225486839172762330742659423724114653226835819397085381257304105257566937592702765853135360490266257083192830870077666275960663723976086310235934350572650480643691450656438652769853018111519504498965737440967647717818784480763727200258889702626069322469743838822112397983393755250519010298110374742466783922925487057158527359106287066137656141433380846258646250390469229071336860949790965072334352962521185854509550842351266605524163986806331802767702307634084162000820507840777885400805512071448246749124225768822589052733208381949931869152348048701648349767479285228581634453249080578720203097097514457").unwrap(),
                v2: BigUint::from_str("11624783050789373146135145081851167787144912685550655481254753886486876945039110175782945406523699017594888407389014880101840909734903251718897005090801524812985842948051908677768943122267838594824514706829210878634123695856103833890298708489700110861686115821849284312876390414092087922712380944749991516509300532655840012200292315982914838173353675847647411050340787544373391445319951232858137394531780600427092367231102522845204917484802409447548360146964783744378214393625590646132406343132441415352603518333034984771651345199420810327304168670235976704426708270671344968176457707557409261114405916868900751036145").unwrap(),
            },
        ]
    });
}
